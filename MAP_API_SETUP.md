# 高德地图 API 密钥配置指南

## 🚨 当前问题

你的 `.env` 文件中的 API 密钥 `98aa98cebdf5818c131fe1987b5a979d` 是无效的，导致出现以下错误：

- `USERKEY_PLAT_NOMATCH` - API 密钥与平台不匹配
- `Unimplemented type: 3` - 高德地图内部错误

## ✅ 解决方案

### 步骤 1：申请高德地图 API 密钥

1. **访问高德开放平台**

   ```
   https://lbs.amap.com/dev/key/app
   ```

2. **注册/登录账号**

   - 如果没有账号，先注册
   - 使用邮箱注册，完成实名认证

3. **创建应用**

   - 点击"创建应用"
   - 应用名称：`顺路带校园互助平台`
   - 应用类型：**Web 应用(JS API)** ⭐ 重要！

4. **添加 API Key**

   - 点击"添加 Key"
   - Key 名称：`地图选址功能`
   - 服务平台：`Web端(JS API)` ⭐ 重要！

5. **复制 API Key**
   - 创建成功后，复制生成的 API Key（通常是 32 位字符串）

### 步骤 2：配置环境变量

在 `E:\deliverapp\deliverapp\frontend\.env` 文件中，将：

```bash
VITE_AMAP_API_KEY=98aa98cebdf5818c131fe1987b5a979d
```

替换为：

```bash
VITE_AMAP_API_KEY=你的真实API密钥
```

**注意：**

- 不要包含引号
- 确保密钥正确无误
- 一个字符都不能错！

### 步骤 3：重启前端服务

```bash
# 停止当前前端服务（如果在运行）
# 然后重新启动
cd frontend
npm run dev
```

### 步骤 4：验证配置

配置完成后：

1. 访问 `http://localhost:4173`
2. 发布任务时点击"地图选址"
3. 如果地图正常加载，配置成功！

## 🔍 常见错误排查

### 错误：`USERKEY_PLAT_NOMATCH`

**原因：** API 密钥的平台类型不正确
**解决：** 确保应用类型是 `Web应用(JS API)`

### 错误：`INVALID_USER_KEY`

**原因：** API 密钥不存在或已删除
**解决：** 检查密钥是否正确输入

### 错误：`INVALID_USER_SCODE`

**原因：** API密钥权限不足，地理编码/逆地理编码/地点搜索服务未开通
**解决：**
1. 登录[高德地图控制台](https://lbs.amap.com/dev/console)
2. 进入"应用管理" → 你的应用
3. 在"服务"选项卡中确保以下服务已勾选：
   - ✅ **地图显示**
   - ✅ **地点搜索** ⭐ JS API搜索功能必需！
   - ✅ **地理编码** ⭐ 地址转坐标功能！
   - ✅ **逆地理编码** ⭐ 坐标转地址功能！
4. 保存设置后等待5-10分钟生效

### 地点搜索无结果

**原因：** 地点搜索服务未开通或搜索关键词无效
**解决：**
1. 确保"地点搜索"服务已开通
2. 使用更具体的搜索关键词（如："北京大学"、"清华大学食堂"）
3. 检查网络连接是否正常

### 错误：地图不显示

**原因：** 密钥未生效（需要几分钟）
**解决：** 等待 5-10 分钟后重试

### 错误：`Get ipLocation failed.Get geolocation timeout.`

**原因：** 地理定位超时或权限被拒绝
**解决：**

1. **允许位置权限**：点击浏览器地址栏左侧的定位图标，允许网站访问位置
2. **网络问题**：检查网络连接，GPS 信号是否良好
3. **手动选择**：直接点击地图选择位置，无需定位
4. **浏览器设置**：确保浏览器支持地理定位 API

### 地理定位相关问题

- **超时 (status: 1)**：网络慢或 GPS 信号弱 → 自动降级为手动选择
- **权限拒绝 (status: 3)**：用户未授权 → 提示允许位置权限
- **位置不可用 (status: 2)**：浏览器不支持 → 引导手动选择位置
- **室内定位问题**：建筑物内信号弱 → 使用 WiFi 定位或手动选择

## 📋 API 密钥要求

- **平台类型：** 必须是 `Web应用(JS API)`
- **域名限制：** 开发环境可以使用 `localhost`
- **服务类型：** 需要勾选 `地图显示`、`地点搜索`、`地理编码`

## 🔗 相关链接

- [高德地图开放平台](https://lbs.amap.com/dev/key/app)
- [JS API 开发文档](https://lbs.amap.com/api/javascript-api-v2/guide/abc/prepare)
- [控制台](https://lbs.amap.com/dev/console)

## 💡 开发环境注意事项

- 开发时可以使用 `localhost` 域名
- 生产环境需要配置真实域名
- 每个 API Key 有每日调用限制

---

配置完成后，你的地图功能就能正常使用了！🎉
